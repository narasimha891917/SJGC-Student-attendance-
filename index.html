<!-- Save as attendance.html or index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Advanced Attendance System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    .container { width: 90%; max-width: 400px; margin: 30px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    #adminDashboard, #studentDashboard { max-width: 1000px; }
    h2, h3 { text-align: center; color: #2c3e50; }
    input, select, button { width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 15px; }
    button { background-color: #28a745; color: white; font-weight: bold; border: none; cursor: pointer; }
    button:hover { background-color: #218838; }
    .link-btn { background: none; border: none; color: #007bff; text-decoration: underline; cursor: pointer; font-size: 14px; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #007bff; color: white; }
    .photo img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #007bff; }
    .form-section label { font-weight: bold; display: block; margin: 8px 0 5px; }
    .present { color: green; font-weight: bold; }
    .absent { color: red; font-weight: bold; }
    .dash { color: gray; font-weight: bold; }
    .flex { display: flex; justify-content: space-between; gap: 20px; flex-wrap: wrap; }
  </style>
</head>
<body>

<!-- Login Section -->
<div class="container" id="loginSection">
  <h2>Login</h2>
  <select id="loginRole">
    <option value="">Select Role</option>
    <option value="student">Student</option>
    <option value="admin">Admin</option>
  </select>
  <input type="text" id="loginName" placeholder="Enter your name">
  <input type="password" id="loginPassword" placeholder="Enter password">
  <button onclick="login()">Login</button>
  <button class="link-btn" onclick="show('registerSection')">New Registration</button>
  <button class="link-btn" onclick="show('forgotSection')">Forgot Password?</button>
</div>

<!-- Registration Section -->
<div class="container hidden" id="registerSection">
  <h2>Register New Student</h2>
  <input type="text" id="regName" placeholder="Full name">
  <input type="password" id="regPassword" placeholder="Password">
  <input type="text" id="regPhone" placeholder="Phone number">
  <input type="text" id="regRoll" placeholder="Roll number">
  <input type="text" id="regCollege" placeholder="College">
  <input type="email" id="regEmail" placeholder="Enter Gmail address (e.g. abc@gmail.com)">
  <select id="regGroup"><option>B.Com</option></select>
  <input type="file" id="regPhoto" accept="image/*">
  <div class="photo"><img id="previewPhoto" src="" alt="Preview Photo"></div>
  <button onclick="register()">Register</button>
  <button class="link-btn" onclick="show('loginSection')">Back to Login</button>
</div>

<!-- Forgot Password Section -->
<div class="container hidden" id="forgotSection">
  <h2>Forgot Password</h2>
  <input type="email" id="forgotEmail" placeholder="Enter your Gmail">
  <input type="text" id="forgotPhone" placeholder="Enter phone number">
  <button onclick="recover()">Recover Password</button>
  <button class="link-btn" onclick="show('loginSection')">Back to Login</button>
</div>

<!-- Student Dashboard -->
<div class="container hidden" id="studentDashboard">
  <h2>Student Dashboard</h2>
  <div class="flex">
    <div>
      <p><strong>Name:</strong> <span id="sName"></span></p>
      <p><strong>Roll No:</strong> <span id="sRoll"></span></p>
      <p><strong>Group:</strong> <span id="sGroup"></span></p>
      <p><strong>College:</strong> <span id="sCollege"></span></p>
      <p><strong>Phone:</strong> <span id="sPhone"></span></p>
    </div>
    <div class="photo"><img id="sPhoto" src="1.jpg" alt="Student Photo"></div>
  </div>
  <h3>Today's Attendance</h3>
  <table><thead><tr><th>Date</th><th>10–11</th><th>11–12</th><th>12–1</th><th>2–3</th><th>3–4</th><th>4–5</th></tr></thead><tbody id="timetableBody"></tbody></table>
  <h3>Last 3 Days Attendance</h3>
  <table><thead><tr><th>Date</th><th>10–11</th><th>11–12</th><th>12–1</th><th>2–3</th><th>3–4</th><th>4–5</th></tr></thead><tbody id="threeDayBody"></tbody></table>
  <button onclick="downloadSummaryPDF()">Download Summary as PDF</button>
  <button onclick="logout()">Logout</button>
</div>

<!-- Admin Dashboard -->
<div class="container hidden" id="adminDashboard">
  <h2>Admin Dashboard</h2>
  <div class="form-section">
    <label>Student Name</label><select id="studentName"></select>
    <label>Date</label><input type="date" id="attDate">
    <label>Time</label>
    <select id="attTime"><option value="10">10–11</option><option value="11">11–12</option><option value="12">12–1</option><option value="14">2–3</option><option value="15">3–4</option><option value="16">4–5</option></select>
    <label>Subject</label>
    <select id="attSubject">
      <option>Stock Market</option><option>Tally</option><option>Digital Marketing</option>
      <option>Web Applications</option><option>Advance Accounting</option><option>Investment Planning</option>
    </select>
    <label>Status</label><select id="attStatus"><option>Present</option><option>Absent</option></select>
    <button onclick="addAttendance()">Add Attendance</button>
  </div>

  <h3>Attendance Records</h3>
  <table><thead><tr><th>Name</th><th>Roll</th><th>Group</th><th>Photo</th><th>Subject</th><th>Date</th><th>Time</th><th>Status</th></tr></thead><tbody id="adminTableBody"></tbody></table>

  <button onclick="logout()">Logout</button>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAlEo10-imB1Hj8oEu4iNf6KD1iDREXbdc",
  authDomain: "results-dashboard.firebaseapp.com",
  databaseURL: "https://results-dashboard-default-rtdb.firebaseio.com",
  projectId: "results-dashboard",
  storageBucket: "results-dashboard.appspot.com",
  messagingSenderId: "465722379609",
  appId: "1:465722379609:web:d995f495bb4d7e61b05048",
  measurementId: "G-B2W818CL13"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let users = { "Admin": { password: "admin123", role: "admin" } };
let regPhotoData = "";
const timeSlots = ["10", "11", "12", "14", "15", "16"];
let loginAttempts = 0;

document.getElementById("regPhoto").addEventListener("change", e => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      regPhotoData = e.target.result;
      document.getElementById("previewPhoto").src = regPhotoData;
    };
    reader.readAsDataURL(file);
  }
});

function show(id) {
  document.querySelectorAll(".container").forEach(div => div.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function login() {
  const name = loginName.value.trim(), pass = loginPassword.value.trim(), role = loginRole.value;
  if (!name || !pass || !role) return alert("Please fill in all fields.");

  if (role === "admin") {
    if (name !== "Admin") return incrementAdminLock("Only the real admin can login.");
    if (pass !== "admin123") return incrementAdminLock("Incorrect admin password.");
    loginAttempts = 0;
    show("adminDashboard");
    populateStudentNames();
    return;
  }

  auth.signInWithEmailAndPassword(`${name}@college.edu`, pass)
    .then(cred => db.collection("students").doc(cred.user.uid).get())
    .then(doc => {
      if (!doc.exists) return alert("Student not found.");
      const data = doc.data();
      show("studentDashboard");
      sName.textContent = data.name;
      sRoll.textContent = data.roll;
      sGroup.textContent = data.group;
      sPhone.textContent = data.phone;
      sCollege.textContent = data.College;
      sPhoto.src = data.photo;
      renderTimetable(data.name);
    })
    .catch(err => alert("Login Error: " + err.message));
}

function incrementAdminLock(msg) {
  loginAttempts++;
  alert(msg);
  if (loginAttempts >= 3) {
    cont adminOpt = document.querySelector('#loginRole option[value="admin"]');
    if (adminOpt) adminOpt.remove();
    alert("Too many attempts. Admin access removed.");
  }
}
function register() {
  const name = regName.value.trim(),
        pass = regPassword.value.trim(),
        phone = regPhone.value.trim(),
        College = regCollege.value.trim(),
        roll = regRoll.value.trim(),
        group = regGroup.value,
        email = regEmail.value.trim();  // NEW

  if (!name || !pass || !phone || !College || !roll || !group || !email || !regPhotoData)
    return alert("All fields required");

  auth.createUserWithEmailAndPassword(email, pass)
    .then(cred => {
      const studentData = {
        uid: cred.user.uid,
        name, phone, College, roll, group,
        email,
        photo: regPhotoData,
        role: "student",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      users[name] = { name, roll, group, photo: regPhotoData, role: "student" };
      return db.collection("students").doc(cred.user.uid).set(studentData);
    })
    .then(() => {
      alert("Registered! Please log in.");
      show("loginSection");
    })
    .catch(err => {
      if (err.code === 'auth/email-already-in-use') {
        alert("This Gmail is already registered. Please log in instead.");
        show("loginSection");
      } else {
        alert("Registration Error: " + err.message);
      }
    });
}


function recover() {
  const email = forgotEmail.value.trim();
  if (!email) return alert("Enter your Gmail");

  auth.sendPasswordResetEmail(email)
    .then(() => alert("Password reset link sent to: " + email))
    .catch(err => alert("Error: " + err.message));
}
function logout() { show("loginSection"); }

function populateStudentNames() {
  const list = document.getElementById("studentName");
  list.innerHTML = "";
  db.collection("students").get().then(snapshot => {
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      const opt = document.createElement("option");
      opt.value = data.name;
      opt.textContent = data.name;
      list.appendChild(opt);
      users[data.name] = {
        name: data.name, roll: data.roll, group: data.group, photo: data.photo, role: "student"
      };
    });
  });
}

function addAttendance() {
  const student = studentName.value, date = attDate.value, time = attTime.value,
        subject = attSubject.value, status = attStatus.value;

  if (!student || !date || !time || !subject || !status)
    return alert("Fill all fields.");

  const user = users[student];
  if (!user) return alert("Student data missing");

  db.collection("attendance").add({ student, date, time, subject, status })
    .then(() => {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${student}</td><td>${user.roll}</td><td>${user.group}</td>
      <td><img src="${user.photo}" width="40" style="border-radius:50%"></td>
      <td>${subject}</td><td>${date}</td><td>${attTime.options[attTime.selectedIndex].text}</td><td>${status}</td>`;
      adminTableBody.appendChild(row);
      alert("Attendance Added");
    })
    .catch(err => alert("Failed to add attendance: " + err.message));
}

function renderTimetable(student) {
  db.collection("attendance").where("student", "==", student).get()
    .then(snapshot => {
      const grouped = {};
      snapshot.docs.forEach(doc => {
        const a = doc.data();
        if (!grouped[a.date]) grouped[a.date] = {};
        grouped[a.date][a.time] = `${a.status} (${a.subject})`;
      });

      timetableBody.innerHTML = "";
      Object.keys(grouped).sort().reverse().forEach(date => {
        let row = `<tr><td>${date}</td>`;
        timeSlots.forEach(t => {
          const val = grouped[date][t];
          row += `<td class="${val?.startsWith('Present') ? 'present' : val?.startsWith('Absent') ? 'absent' : 'dash'}">${val || '-'}</td>`;
        });
        timetableBody.innerHTML += row + "</tr>";
      });

      renderThreeDayTable(grouped);
    });
}

function renderThreeDayTable(grouped) {
  const body = document.getElementById("threeDayBody");
  body.innerHTML = "";
  const dates = [...Array(3)].map((_, i) => {
    const d = new Date(); d.setDate(d.getDate() - i);
    return d.toISOString().split("T")[0];
  });
  dates.forEach((date, i) => {
    const color = i === 0 ? "#d4edda" : i === 1 ? "#d1ecf1" : "#e2e3e5";
    let row = `<tr style="background:${color}"><td><b>${date}</b></td>`;
    timeSlots.forEach(slot => {
      const entry = grouped[date]?.[slot];
      row += `<td class="${entry?.startsWith("Present") ? 'present' : entry?.startsWith("Absent") ? 'absent' : 'dash'}">${entry || '-'}</td>`;
    });
    body.innerHTML += row + "</tr>";
  });
}

function downloadSummaryPDF() {
  html2canvas(document.querySelector("#threeDayBody").closest("table")).then(canvas => {
    const pdf = new jspdf.jsPDF();
    const w = pdf.internal.pageSize.getWidth(), h = canvas.height * w / canvas.width;
    pdf.addImage(canvas.toDataURL("image/png"), "PNG", 0, 0, w, h);
    pdf.save("attendance_summary.pdf");
  });
}
</script>
</body>
</html>
